---
title: "ITS2 Data"
description: "Internal Transcribed Spacer 2 sequences and analysis"
format:
  html:
    code-copy: true
    toc: true
    toc-location: right
    toc-expand: true
editor: visual
execute:
  echo: false
  warning: false
  message: false
---

```{r setup, include=FALSE}
# Check and load required packages
required_packages <- c("tidyverse", "DT", "readxl", "plotly", "readr", "dplyr", "tibble", "knitr", "gt", "htmltools")

# Function to safely load packages
safe_load_package <- function(pkg) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    install.packages(pkg, dependencies = TRUE)
    library(pkg, character.only = TRUE)
  }
}

# Load all required packages
for (pkg in required_packages) {
  safe_load_package(pkg)
}
```

```{r data-config, cache=TRUE, include=FALSE}

# =============================================================================
# ITS2 DATA CONFIGURATION
# =============================================================================
# Using the ITS2 relative abundance matrix from the timeseries repository

its2_data_url <- "https://raw.githubusercontent.com/urol-e5/timeseries/master/time_series_analysis/Output/ITS2_rel_abund_matrix.csv"

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

# Create download button
create_download_button <- function(url, filename = NULL, button_text = NULL) {
  if (is.null(url) || url == "") {
    return("")
  }
  
  if (is.null(filename) || length(filename) == 0) {
    filename <- "download"
  }
  
  if (is.null(button_text) || length(button_text) == 0) {
    button_text <- "Download"
  }
  
  # Return HTML as a string that can be directly output
  paste0('<a href="', url, '" class="btn btn-primary" target="_blank" download="', filename, '">', button_text, '</a>')
}

# =============================================================================
# DATA LOADING
# =============================================================================

# Load the ITS2 data
cat("Loading ITS2 data from:", its2_data_url, "\n")
its2_data <- tryCatch({
  read_csv(its2_data_url, show_col_types = FALSE)
}, error = function(e) {
  warning(paste("Failed to load ITS2 data:", e$message))
  data.frame()
})

# Check if data was loaded successfully
if (nrow(its2_data) == 0) {
  cat("Warning: No ITS2 data was loaded successfully.\n")
}

```

## Interactive ITS2 Data Explorer

This page provides interactive visualization and searchable tables for Internal Transcribed Spacer 2 (ITS2) relative abundance data across coral species and time points.

ITS2 sequences are important molecular markers used for coral symbiont identification and community analysis, particularly useful for studying changes in symbiont communities over time.

## Data Overview

```{r data-overview}
if (nrow(its2_data) > 0) {
  # Basic data summary
  cat("**Dataset Summary:**\n")
  cat(paste("- Total samples:", nrow(its2_data), "\n"))
  cat(paste("- Time points:", length(unique(its2_data$timepoint)), "\n"))
  cat(paste("- Species:", length(unique(its2_data$species)), "\n"))
  cat(paste("- Sites:", length(unique(its2_data$site)), "\n"))
  cat(paste("- ITS2 types:", ncol(its2_data) - 9, "\n")) # subtract metadata columns
  
  # Create summary table
  summary_table <- its2_data %>%
    group_by(species, timepoint) %>%
    summarise(
      n_samples = n(),
      sites = paste(unique(site), collapse = ", "),
      .groups = "drop"
    )
  
  summary_table %>%
    gt() %>%
    tab_header(title = "ITS2 Data Summary by Species and Time Point") %>%
    cols_label(
      species = "Species",
      timepoint = "Time Point", 
      n_samples = "Sample Count",
      sites = "Sites"
    )
} else {
  cat("No ITS2 data available.")
}
```

## Time Series Visualization

```{r timeseries-plot}
if (nrow(its2_data) > 0) {
  # Get ITS2 type columns (skip metadata columns)
  metadata_cols <- c("colony_id", "colony_id_corr", "timepoint", "site", "nutrient", "site_code", "month", "haplotype", "species")
  its2_type_cols <- setdiff(names(its2_data), metadata_cols)
  
  # Prepare data for plotting - select top abundant types for visualization
  plot_data <- its2_data %>%
    select(all_of(c(metadata_cols, its2_type_cols))) %>%
    pivot_longer(cols = all_of(its2_type_cols), names_to = "its2_type", values_to = "abundance") %>%
    filter(abundance > 0) %>%
    group_by(its2_type) %>%
    summarise(total_abundance = sum(abundance, na.rm = TRUE), .groups = "drop") %>%
    slice_max(total_abundance, n = 10) %>%  # Top 10 most abundant types
    pull(its2_type)
  
  # Create plot data
  timepoint_data <- its2_data %>%
    select(all_of(c(metadata_cols, plot_data))) %>%
    pivot_longer(cols = all_of(plot_data), names_to = "its2_type", values_to = "abundance") %>%
    filter(abundance > 0) %>%
    group_by(species, timepoint, its2_type) %>%
    summarise(
      mean_abundance = mean(abundance, na.rm = TRUE),
      n_samples = n(),
      .groups = "drop"
    )
  
  if (nrow(timepoint_data) > 0) {
    # Get unique species for faceting
    species_list <- unique(timepoint_data$species)
    
    # Create individual plots for each species
    species_plots <- list()
    
    for (i in seq_along(species_list)) {
      species_name <- species_list[i]
      species_data <- timepoint_data %>% filter(species == species_name)
      
      if (nrow(species_data) > 0) {
        species_plots[[i]] <- species_data %>%
          plot_ly(x = ~timepoint, y = ~mean_abundance, color = ~its2_type, 
                  type = "scatter", mode = "lines+markers",
                  hovertemplate = paste0("Species: ", species_name, "<br>ITS2 Type: %{fullData.name}<br>Timepoint: %{x}<br>Mean Abundance: %{y:.4f}<br>Samples: %{text}<extra></extra>"),
                  text = ~n_samples, showlegend = (i == 1)) %>%
          layout(
            xaxis = list(title = list(text = "Time Point", font = list(size = 12)), 
                        tickfont = list(size = 11)),
            yaxis = list(title = list(text = "Mean Relative Abundance", font = list(size = 12)), 
                        tickfont = list(size = 11)),
            hovermode = "closest"
          )
      }
    }
    
    # Remove any NULL plots
    species_plots <- species_plots[!sapply(species_plots, is.null)]
    
    if (length(species_plots) > 0) {
      # Combine plots into subplots - arrange vertically or in grid depending on number of species
      if (length(species_plots) <= 3) {
        # Arrange vertically for up to 3 species
        # Reduced height calculation and margins to minimize white space
        plot_height <- max(400, length(species_plots) * 280)
        
        p <- subplot(species_plots, nrows = length(species_plots), 
                    shareX = TRUE, shareY = FALSE, margin = 0.08,
                    titleY = TRUE, titleX = TRUE) %>%
          layout(
            title = list(text = "ITS2 Relative Abundance Across Time Points by Species", 
                        font = list(size = 16)),
            showlegend = TRUE,
            height = plot_height
          )
        
        # Add species annotations to make labels more prominent
        annotations <- list()
        for (i in seq_along(species_list)) {
          y_position <- 1 - (i - 1) / length(species_list) - 0.02
          annotations[[i]] <- list(
            text = paste("<b>", species_list[i], "</b>"),
            x = 0.02, y = y_position,
            xref = "paper", yref = "paper",
            xanchor = "left", yanchor = "top",
            showarrow = FALSE,
            font = list(size = 14, color = "black"),
            bgcolor = "rgba(255,255,255,0.8)",
            bordercolor = "rgba(0,0,0,0.1)",
            borderwidth = 1
          )
        }
        p <- p %>% layout(annotations = annotations)
        
      } else {
        # Arrange in grid for more than 3 species  
        ncols <- min(2, ceiling(sqrt(length(species_plots))))
        nrows <- ceiling(length(species_plots) / ncols)
        # Reduced height calculation and margins to minimize white space
        plot_height <- max(400, nrows * 280)
        
        p <- subplot(species_plots, nrows = nrows, shareX = TRUE, shareY = FALSE, 
                    margin = 0.06, titleY = TRUE, titleX = TRUE) %>%
          layout(
            title = list(text = "ITS2 Relative Abundance Across Time Points by Species", 
                        font = list(size = 16)),
            showlegend = TRUE,
            height = plot_height
          )
        
        # Add species annotations for grid layout
        annotations <- list()
        for (i in seq_along(species_list)) {
          row <- ceiling(i / ncols)
          col <- ((i - 1) %% ncols) + 1
          x_position <- (col - 1) / ncols + 0.02
          y_position <- 1 - (row - 1) / nrows - 0.02
          annotations[[i]] <- list(
            text = paste("<b>", species_list[i], "</b>"),
            x = x_position, y = y_position,
            xref = "paper", yref = "paper",
            xanchor = "left", yanchor = "top",
            showarrow = FALSE,
            font = list(size = 14, color = "black"),
            bgcolor = "rgba(255,255,255,0.8)",
            bordercolor = "rgba(0,0,0,0.1)",
            borderwidth = 1
          )
        }
        p <- p %>% layout(annotations = annotations)
      }
      
      p
    } else {
      cat("No valid species data available for visualization.")
    }
  } else {
    cat("No abundance data available for visualization.")
  }
} else {
  cat("No time series data available for visualization.")
}
```

## Interactive Data Tables

```{r its-links, results='asis', echo=FALSE}
if (nrow(its2_data) > 0) {
  download_btn <- create_download_button(its2_data_url, "ITS2_rel_abund_matrix.csv", "Download ITS2 Data")
  cat(download_btn, "<br><br>")
  cat("Data source: <a href=\"", its2_data_url, "\" target=\"_blank\">ITS2_rel_abund_matrix.csv</a><br><br>")
  cat("**Interactive Data Table**<br><br>")
} else {
  cat("No ITS2 data available for display.")
}
```

```{r interactive-table, echo=FALSE}
if (nrow(its2_data) > 0) {
  DT::datatable(
    its2_data,
    filter = "top",
    extensions = c("Buttons", "Scroller"),
    options = list(
      dom = "Bfrtip",
      buttons = c("copy", "csv", "excel"),
      pageLength = 25,
      deferRender = TRUE,
      scrollY = 400,
      scroller = TRUE,
      scrollX = TRUE
    ),
    class = "display nowrap"
  )
}
```

## Data Sources and Methods

### ITS2 Sequencing

Internal Transcribed Spacer 2 (ITS2) is a highly variable DNA region located between the 5.8S and 28S ribosomal RNA genes. This region is commonly used for:

- Coral symbiont identification
- Symbiodiniaceae community analysis
- Temporal changes in symbiont communities
- Response to environmental stressors

### Data Structure

This dataset contains relative abundance values for different ITS2 types across:

- **Timepoints**: 4 time points (timepoint1-4) representing temporal sampling
- **Sites**: Multiple reef sites with different environmental conditions
- **Nutrient Treatments**: High and low nutrient conditions
- **Species**: Multiple coral species including *Acropora* and others
- **ITS2 Types**: Relative abundance values for ~40 different ITS2 sequence variants

### Data Processing

1. **Sequence Quality Control**: Raw ITS2 sequences underwent quality filtering
2. **Taxonomic Assignment**: Sequences were assigned to ITS2 type profiles using SymPortal
3. **Relative Abundance**: Count data was normalized to relative abundance within each sample
4. **Matrix Format**: Data organized with samples as rows and ITS2 types as columns

### Download

The complete dataset is available for download using the button provided above. The file contains:
- Sample metadata (colony ID, timepoint, site, nutrient treatment, species)
- Relative abundance values for all detected ITS2 types